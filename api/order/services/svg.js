const qrcode = require("qrcode-generator");

const svg64 = require("svg64");

var escapeXml = function (s) {
  var escaped = "";
  for (var i = 0; i < s.length; i += 1) {
    var c = s.charAt(i);
    switch (c) {
      case "<":
        escaped += "&lt;";
        break;
      case ">":
        escaped += "&gt;";
        break;
      case "&":
        escaped += "&amp;";
        break;
      case '"':
        escaped += "&quot;";
        break;
      default:
        escaped += c;
        break;
    }
  }
  return escaped;
};

module.exports = (typeNumber, errorCorrectionLevel) => {
  const qr = qrcode(typeNumber, errorCorrectionLevel);
  qr.createWithLogo = function (logoSize) {
    const cellSize = 5;
    const margin = cellSize;

    // SVG properties

    const alt = { id: "QRCode-description", text: "QRCode for ticket" };
    const title = { text: "Title", id: "qrcode-title" };

    const size = qr.getModuleCount() * cellSize + margin * 2;
    logoSize = logoSize || size * 0.33;
    const min = margin;
    const max = size - margin;

    const cMin = (max - logoSize) / 2;
    const cMax = (max + logoSize) / 2;

    let c,
      mc,
      r,
      mr,
      qrSvg = "",
      rect;

    rect =
      "l" +
      cellSize +
      ",0 0," +
      cellSize +
      " -" +
      cellSize +
      ",0 0,-" +
      cellSize +
      "z ";

    qrSvg += '<svg version="1.1" xmlns="http://www.w3.org/2000/svg"';
    //qrSvg += !opts.scalable ? ' width="' + size + 'px" height="' + size + 'px"' : '';
    qrSvg += ' viewBox="0 0 ' + size + " " + size + '" ';
    qrSvg += ' preserveAspectRatio="xMinYMin meet"';
    qrSvg +=
      title.text || alt.text
        ? ' role="img" aria-labelledby="' +
          escapeXml([title.id, alt.id].join(" ").trim()) +
          '"'
        : "";
    qrSvg += ">";
    qrSvg += title.text
      ? '<title id="' +
        escapeXml(title.id) +
        '">' +
        escapeXml(title.text) +
        "</title>"
      : "";
    qrSvg += alt.text
      ? '<description id="' +
        escapeXml(alt.id) +
        '">' +
        escapeXml(alt.text) +
        "</description>"
      : "";
    qrSvg += '<rect width="100%" height="100%" fill="white" cx="0" cy="0"/>';
    qrSvg += '<path d="';

    for (r = 0; r < qr.getModuleCount(); r += 1) {
      mr = r * cellSize + margin;
      for (c = 0; c < qr.getModuleCount(); c += 1) {
        if (!(c >= cMin && c < cMax && r >= cMin && r < cMax)) {
          if (qr.isDark(r, c)) {
            mc = c * cellSize + margin;
            qrSvg += "M" + mc + "," + mr + rect;
            //qrSvg += `M ${mc - 4}, ${mr} a 4,4 0 1, 1 8,0 a 4,4 0 1, 1 -8,0`;
          }
        }
      }
    }
    const orginalLogoSize = 40;
    const t = (size - orginalLogoSize) / 2;
    const transform = `transform="translate(${t},${t})"`;
    qrSvg += '" stroke="transparent" fill="black"/>';
    qrSvg += `<circle ${transform} cx="20" cy="20" r="20" fill="white"/>
        <path ${transform} d="M17.7744 35.1071C17.7311 34.6526 17.7308 34.6527 17.7308 34.6527L17.7744 35.1071Z" fill="url(#paint0_linear)"/>
        <path ${transform} d="M26.3711 29.5501C26.3711 29.5501 26.3721 29.5491 26.3751 29.5472C26.3727 29.5492 26.3711 29.5501 26.3711 29.5501Z" fill="url(#paint1_linear)"/>
        <path ${transform} fill-rule="evenodd" clip-rule="evenodd" d="M22.5372 2.08956C23.0716 2.00568 23.5247 1.83063 23.8523 1.54781C24.1784 1.26623 24.3576 0.895594 24.3714 0.479165C33.3147 2.47311 40 10.4558 40 20C40 31.0457 31.0457 40 20 40C8.9543 40 0 31.0457 0 20C0 8.9543 8.9543 0 20 0C20.2255 0 20.4501 0.00373137 20.6738 0.0111357C20.6011 0.178697 20.5589 0.367569 20.5589 0.578277C20.5589 1.07774 20.7052 1.54717 21.1049 1.8445C21.4898 2.13084 22.0009 2.17375 22.5372 2.08956ZM20.8235 9.35975L20.8393 9.30396L20.9046 9.10779C20.9314 9.02737 20.9651 8.92571 21.0044 8.80687C21.2259 8.80845 21.4355 8.80519 21.6323 8.80213L21.6363 8.80207C21.8875 8.79816 22.1145 8.79471 22.3319 8.8005C23.9781 8.84438 24.9975 8.87264 25.8341 9.01455C26.6366 9.15068 27.2744 9.3929 28.1296 9.88582C28.5357 10.2076 28.8227 10.508 29.0334 10.8345C29.2474 11.1662 29.3961 11.5454 29.4977 12.0372C29.7068 13.0491 29.706 14.4616 29.7006 16.7918C29.6998 17.168 29.6989 17.5671 29.6989 17.9903L29.6989 17.9978C29.704 18.3055 29.7097 18.6128 29.7153 18.9161L29.7154 18.9182C29.7405 20.27 29.7639 21.5396 29.7279 22.5097C29.7098 22.9962 29.6773 23.3893 29.627 23.672C29.6017 23.814 29.5747 23.912 29.5502 23.9738C29.5451 23.9866 29.5408 23.9963 29.5373 24.0034C29.3077 24.163 29.1605 24.2371 29.0102 24.2869C28.8385 24.3439 28.6451 24.376 28.2845 24.4336L28.2833 24.4338L28.2824 24.4339L28.2807 24.4342C28.1496 24.4551 27.9999 24.479 27.8286 24.5083C27.6074 24.5462 27.3954 24.5808 27.1927 24.6138L27.1443 24.6217C26.4834 24.7293 25.8802 24.8276 25.4676 24.9802C25.2572 25.058 25.0249 25.174 24.8675 25.3725C24.6834 25.6045 24.6517 25.8821 24.7326 26.1499C24.9973 27.0261 25.7573 27.4035 26.2383 27.6423L26.2774 27.6618C26.4192 27.7323 26.529 27.788 26.6147 27.8385C26.5002 27.8855 26.3487 27.9426 26.1497 28.0102C26.0618 28.0401 25.9655 28.0694 25.8581 28.102L25.8339 28.1093C25.5807 28.1861 25.2533 28.2854 24.9899 28.4358C24.7124 28.5943 24.3916 28.8778 24.3916 29.351C24.3916 29.8451 24.597 30.1932 24.912 30.4125C25.1109 30.5509 25.3406 30.6264 25.5254 30.6746C25.4199 30.7349 25.2947 30.8142 25.1878 30.9152C25.0168 31.0766 24.874 31.3087 24.874 31.6232C24.874 31.9609 25.0379 32.2758 25.1969 32.5202C25.3601 32.771 25.5705 33.0236 25.7544 33.2444L25.7637 33.2556C25.9384 33.4653 26.0874 33.6449 26.1947 33.805C26.2311 33.8592 26.2571 33.9033 26.2756 33.9382C26.2282 33.957 26.1652 33.9784 26.0834 34.0012C25.7356 34.0982 25.1868 34.1835 24.4254 34.26C22.9108 34.4121 20.6641 34.5195 17.7536 34.6511C17.7461 34.6514 17.7383 34.652 17.7308 34.6527L17.7279 34.6529L17.7224 34.6535L17.7046 34.6554C17.6953 34.6565 17.6837 34.6578 17.6701 34.6596L17.6438 34.663C17.5929 34.6698 17.5218 34.6804 17.4365 34.6962C17.2674 34.7275 17.0358 34.7804 16.7943 34.8671C16.3571 35.0239 15.6807 35.367 15.553 36.0884C15.5424 36.1488 15.5348 36.2421 15.5666 36.3466C15.602 36.4631 15.6768 36.5611 15.7776 36.6264C15.9406 36.7322 16.1188 36.7179 16.1774 36.713C16.3201 36.701 16.5145 36.6508 16.7038 36.6019L16.7407 36.5924C17.2546 36.46 18.0774 36.2481 19.2473 36.1689C21.0155 36.0932 23.0506 35.9983 24.6939 35.8939C25.5158 35.8417 26.2445 35.7868 26.7944 35.7303C27.0687 35.7021 27.3049 35.6729 27.4885 35.6424C27.58 35.6272 27.6649 35.6106 27.7381 35.5921C27.7997 35.5764 27.8942 35.5498 27.9779 35.501C28.0081 35.4835 28.0361 35.4625 28.0615 35.4386C28.3644 35.1533 28.453 34.7215 28.4028 34.2966C28.3516 33.8626 28.1535 33.3752 27.7996 32.8752C27.7879 32.8587 27.7752 32.843 27.7614 32.8282C27.2263 32.2522 26.9459 31.937 26.8049 31.7512C26.8625 31.7066 26.9328 31.6575 27.0199 31.5969L27.0297 31.5902C27.1595 31.5 27.3231 31.3863 27.4657 31.2583C27.6093 31.1295 27.7738 30.9501 27.8573 30.7144C27.8745 30.6657 27.8833 30.6145 27.8833 30.5629C27.8833 30.1493 27.5244 29.7117 26.919 29.5216C26.8368 29.4958 26.7658 29.4716 26.7047 29.4488C26.7758 29.4343 26.8563 29.4194 26.9477 29.4027L26.9781 29.3972C27.2722 29.3436 27.6724 29.2708 27.9975 29.1002C28.1747 29.0072 28.352 28.8749 28.4841 28.6811C28.6094 28.4973 28.6773 28.2825 28.6864 28.0437C28.6923 28.0114 28.6973 27.973 28.6994 27.9292C28.7044 27.8258 28.6933 27.6958 28.6459 27.547C28.5502 27.2465 28.3201 26.9085 27.8623 26.5636C27.8371 26.5446 27.81 26.5283 27.7815 26.5148C27.6118 26.4349 27.4373 26.3427 27.2766 26.2494C27.4851 26.2341 27.7125 26.2328 27.9657 26.2328L27.9957 26.2328C28.867 26.2329 29.9548 26.233 30.9564 25.2897C30.965 25.2816 30.9732 25.2732 30.9811 25.2645C31.4535 24.7454 31.6654 24.0859 31.7691 23.2811C31.8711 22.4903 31.8753 21.4941 31.8806 20.2582L31.8807 20.2279C31.8835 19.5657 31.8866 18.8277 31.9038 17.9998C31.9066 17.8693 31.9094 17.7384 31.9122 17.6071L31.9127 17.585C31.9465 16.0273 31.9818 14.403 31.8046 12.954C31.6274 11.5042 31.2298 10.151 30.3329 9.19611C30.3204 9.18279 30.3071 9.17022 30.2931 9.15848C29.0458 8.11424 28.0007 7.56428 26.854 7.28131C25.7392 7.00621 24.5504 6.99117 23.0592 6.97231L23.0182 6.97179C22.5807 6.96625 22.1143 6.96034 21.6102 6.94814L21.6345 6.87242C21.834 6.24876 22.0345 5.60856 22.1854 5.09566C22.2607 4.83966 22.3248 4.61158 22.3704 4.43153C22.3932 4.34177 22.4124 4.25982 22.4262 4.19014C22.4381 4.13061 22.4528 4.04776 22.4528 3.97166C22.4528 3.68693 22.2701 3.48872 22.1128 3.3829C21.9454 3.27026 21.7372 3.20775 21.52 3.19411C21.0745 3.16614 20.5514 3.33783 20.0695 3.79173C20.0263 3.83242 19.9914 3.88107 19.9669 3.93497C19.7107 4.49807 19.2659 5.80207 18.8955 6.93049H8.60731C8.4896 6.93049 8.37639 6.97542 8.29104 7.05601C8.12896 7.20904 8.07676 7.40394 8.06367 7.55133C8.05041 7.70062 8.07209 7.84738 8.10318 7.97036C8.13496 8.09604 8.18192 8.21798 8.23571 8.3238C8.28581 8.42234 8.35744 8.53798 8.45228 8.62731C8.53758 8.70765 8.65062 8.75243 8.76813 8.75243C9.12742 8.75243 9.6454 8.75348 10.296 8.7548L10.3506 8.75491C12.1981 8.75866 14.996 8.76435 18.3092 8.75452L18.2551 8.9267L18.2363 8.98668C18.233 8.99729 18.2301 9.00802 18.2276 9.01885C18.2297 9.00951 18.2284 9.01348 18.2196 9.04051C18.2135 9.05897 18.204 9.08821 18.1896 9.13131C18.16 9.21989 18.1173 9.34619 18.0626 9.50729C17.9544 9.82574 17.8001 10.2772 17.6094 10.8354L17.603 10.8542L17.6027 10.8551L17.6024 10.8559C16.6636 13.6036 14.8555 18.8957 13.3331 23.5564C12.5721 25.8864 11.8811 28.0627 11.4057 29.6857C11.1683 30.496 10.9826 31.1756 10.8688 31.67C10.8123 31.9154 10.7707 32.1271 10.7507 32.291C10.7409 32.3714 10.7341 32.4564 10.7375 32.5352C10.7392 32.5746 10.7439 32.6262 10.7581 32.6815C10.7706 32.7307 10.801 32.8249 10.8816 32.9112C10.9927 33.0302 11.1588 33.0815 11.3181 33.0462C11.6181 32.9798 11.88 32.7805 12.1 32.557C12.3281 32.3254 12.5569 32.0204 12.7848 31.6655C13.2413 30.9547 13.7284 29.989 14.2264 28.8685C15.224 26.6241 16.2916 23.6984 17.2698 20.8035C18.2488 17.9061 19.1418 15.0289 19.7899 12.8768C20.1139 11.8006 20.3769 10.9052 20.5589 10.2787C20.6499 9.96542 20.7207 9.71937 20.7687 9.55151C20.7927 9.46758 20.8111 9.4032 20.8235 9.35975Z" fill="url(#paint2_linear)"/>
        <defs>
        <linearGradient id="paint0_linear" x1="20" y1="40" x2="20" y2="-11.7143" gradientUnits="userSpaceOnUse">
        <stop stop-color="#976E49"/>
        <stop offset="1" stop-color="#DECBBA"/>
        </linearGradient>
        <linearGradient id="paint1_linear" x1="20" y1="40" x2="20" y2="-11.7143" gradientUnits="userSpaceOnUse">
        <stop stop-color="#976E49"/>
        <stop offset="1" stop-color="#DECBBA"/>
        </linearGradient>
        <linearGradient id="paint2_linear" x1="20" y1="40" x2="20" y2="-11.7143" gradientUnits="userSpaceOnUse">
        <stop stop-color="#976E49"/>
        <stop offset="1" stop-color="#DECBBA"/>
        </linearGradient>
        </defs>`;
    qrSvg += "</svg>";
    return svg64(qrSvg);
  };
  return qr;
};
