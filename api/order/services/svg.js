const qrcode = require("qrcode-generator");

const svg64 = require("svg64");

var escapeXml = function (s) {
  var escaped = "";
  for (var i = 0; i < s.length; i += 1) {
    var c = s.charAt(i);
    switch (c) {
      case "<":
        escaped += "&lt;";
        break;
      case ">":
        escaped += "&gt;";
        break;
      case "&":
        escaped += "&amp;";
        break;
      case '"':
        escaped += "&quot;";
        break;
      default:
        escaped += c;
        break;
    }
  }
  return escaped;
};

module.exports = (typeNumber, errorCorrectionLevel) => {
  const qr = qrcode(typeNumber, errorCorrectionLevel);
  qr.createWithLogo = function (logoSize) {
    const cellSize = 5;
    const margin = cellSize;

    // SVG properties

    const alt = { id: "QRCode-description", text: "QRCode for ticket" };
    const title = { text: "Title", id: "qrcode-title" };

    const size = qr.getModuleCount() * cellSize + margin * 2;
    logoSize = logoSize || size * 0.33;
    const min = margin;
    const max = size - margin;

    const cMin = (max - logoSize) / 2;
    const cMax = (max + logoSize) / 2;

    let c,
      mc,
      r,
      mr,
      qrSvg = "",
      rect;

    rect =
      "l" +
      cellSize +
      ",0 0," +
      cellSize +
      " -" +
      cellSize +
      ",0 0,-" +
      cellSize +
      "z ";

    qrSvg += '<svg version="1.1" xmlns="http://www.w3.org/2000/svg"';
    //qrSvg += !opts.scalable ? ' width="' + size + 'px" height="' + size + 'px"' : '';
    qrSvg += ' viewBox="0 0 ' + size + " " + size + '" ';
    qrSvg += ' preserveAspectRatio="xMinYMin meet"';
    qrSvg +=
      title.text || alt.text
        ? ' role="img" aria-labelledby="' +
          escapeXml([title.id, alt.id].join(" ").trim()) +
          '"'
        : "";
    qrSvg += ">";
    qrSvg += title.text
      ? '<title id="' +
        escapeXml(title.id) +
        '">' +
        escapeXml(title.text) +
        "</title>"
      : "";
    qrSvg += alt.text
      ? '<description id="' +
        escapeXml(alt.id) +
        '">' +
        escapeXml(alt.text) +
        "</description>"
      : "";
    qrSvg += '<rect width="100%" height="100%" fill="white" cx="0" cy="0"/>';
    qrSvg += '<path d="';

    for (r = 0; r < qr.getModuleCount(); r += 1) {
      mr = r * cellSize + margin;
      for (c = 0; c < qr.getModuleCount(); c += 1) {
        if (!(c >= cMin && c < cMax && r >= cMin && r < cMax)) {
          if (qr.isDark(r, c)) {
            mc = c * cellSize + margin;
            qrSvg += "M" + mc + "," + mr + rect;
            //qrSvg += `M ${mc - 4}, ${mr} a 4,4 0 1, 1 8,0 a 4,4 0 1, 1 -8,0`;
          }
        }
      }
    }
    const t = (size - 70) / 2;
    qrSvg += '" stroke="transparent" fill="black"/>';
    qrSvg += `<circle transform="translate(${t},${t})" cx="35" cy="35" r="35" fill="white"/>
        <path transform="translate(${t},${t})" d="M31.1053 61.4375C31.0294 60.6421 31.029 60.6422 31.029 60.6422L31.1053 61.4375Z" fill="url(#paint0_linear)"/>
        <path transform="translate(${t},${t})" d="M46.1494 51.7126C46.1494 51.7126 46.1512 51.7108 46.1564 51.7076C46.1522 51.7111 46.1494 51.7126 46.1494 51.7126Z" fill="url(#paint1_linear)"/>
        <path transform="translate(${t},${t})" fill-rule="evenodd" clip-rule="evenodd" d="M39.4401 3.65673C40.3753 3.50994 41.1683 3.2036 41.7415 2.70866C42.3123 2.2159 42.6258 1.56729 42.65 0.838539C58.3007 4.32794 70 18.2977 70 35C70 54.33 54.33 70 35 70C15.67 70 0 54.33 0 35C0 15.67 15.67 0 35 0C35.3946 0 35.7877 0.0065299 36.1791 0.0194875C36.0519 0.312719 35.9781 0.643246 35.9781 1.01199C35.9781 1.88604 36.234 2.70755 36.9335 3.22788C37.6072 3.72898 38.5016 3.80406 39.4401 3.65673ZM36.441 16.3796L36.4687 16.2819L36.5831 15.9386C36.6299 15.7979 36.6889 15.62 36.7577 15.412C37.1453 15.4148 37.5121 15.4091 37.8565 15.4037L37.8636 15.4036C38.3031 15.3968 38.7005 15.3907 39.0808 15.4009C41.9617 15.4777 43.7456 15.5271 45.2096 15.7755C46.6141 16.0137 47.7302 16.4376 49.2267 17.3002C49.9375 17.8633 50.4397 18.3889 50.8085 18.9605C51.183 19.5408 51.4431 20.2045 51.621 21.0651C51.9869 22.8359 51.9855 25.3078 51.9761 29.3856C51.9746 30.0441 51.973 30.7424 51.973 31.4831L51.9731 31.4962C51.982 32.0346 51.992 32.5724 52.0019 33.1032L52.0019 33.1069C52.0459 35.4725 52.0869 37.6944 52.0238 39.392C51.9922 40.2433 51.9353 40.9314 51.8472 41.4261C51.803 41.6745 51.7556 41.8461 51.7128 41.9541C51.704 41.9765 51.6963 41.9935 51.6903 42.0059C51.2886 42.2852 51.0308 42.4149 50.7679 42.5021C50.4673 42.6018 50.1289 42.6581 49.4978 42.7587L49.4959 42.7591L49.4943 42.7593L49.4912 42.7598C49.2618 42.7964 48.9998 42.8382 48.7 42.8896C48.3129 42.9559 47.942 43.0163 47.5872 43.0742L47.5025 43.0879C46.3459 43.2763 45.2904 43.4483 44.5682 43.7154C44.2001 43.8515 43.7936 44.0545 43.5181 44.4018C43.196 44.8078 43.1405 45.2937 43.2821 45.7623C43.7453 47.2957 45.0753 47.9561 45.917 48.3741L45.9854 48.4081C46.2336 48.5316 46.4257 48.629 46.5757 48.7174C46.3753 48.7996 46.1102 48.8995 45.7619 49.0179C45.6081 49.0701 45.4397 49.1214 45.2516 49.1785L45.2094 49.1913C44.7663 49.3257 44.1932 49.4995 43.7323 49.7627C43.2467 50.04 42.6852 50.5362 42.6852 51.3643C42.6852 52.229 43.0447 52.8381 43.5961 53.2218C43.944 53.464 44.3461 53.5963 44.6694 53.6806C44.4848 53.7861 44.2658 53.9249 44.0786 54.1016C43.7794 54.384 43.5296 54.7902 43.5296 55.3406C43.5296 55.9316 43.8164 56.4826 44.0946 56.9103C44.3802 57.3493 44.7483 57.7912 45.0703 58.1777L45.0865 58.1972C45.3922 58.5643 45.6529 58.8787 45.8408 59.1587C45.9044 59.2536 45.9499 59.3307 45.9824 59.3919C45.8993 59.4247 45.7891 59.4622 45.6459 59.5021C45.0372 59.6719 44.077 59.8212 42.7445 59.955C40.0939 60.2211 36.1621 60.4091 31.0687 60.6394C31.0556 60.64 31.0421 60.6409 31.029 60.6422L31.0239 60.6427L31.0142 60.6436L30.9831 60.647C30.9668 60.6488 30.9466 60.6512 30.9226 60.6542L30.8767 60.6602C30.7877 60.6721 30.6631 60.6907 30.5138 60.7184C30.218 60.7732 29.8126 60.8657 29.39 61.0174C28.6249 61.2919 27.4412 61.8922 27.2178 63.1547C27.1991 63.2603 27.1859 63.4237 27.2415 63.6065C27.3035 63.8104 27.4344 63.9819 27.6107 64.0962C27.8961 64.2813 28.2079 64.2563 28.3104 64.2477C28.5603 64.2268 28.9004 64.1389 29.2317 64.0534L29.2962 64.0368C30.1955 63.805 31.6354 63.4342 33.6828 63.2956C36.7772 63.1631 40.3386 62.9971 43.2144 62.8144C44.6527 62.723 45.9278 62.6269 46.8902 62.528C47.3702 62.4787 47.7835 62.4275 48.1049 62.3741C48.265 62.3475 48.4136 62.3185 48.5416 62.2861C48.6495 62.2588 48.8148 62.2121 48.9613 62.1268C49.0141 62.096 49.0632 62.0594 49.1077 62.0175C49.6377 61.5183 49.7927 60.7626 49.705 60.019C49.6154 59.2595 49.2687 58.4067 48.6493 57.5317C48.6289 57.5028 48.6066 57.4753 48.5825 57.4494C47.6459 56.4413 47.1553 55.8898 46.9086 55.5646C47.0093 55.4866 47.1324 55.4006 47.2849 55.2946L47.3019 55.2828C47.5291 55.1249 47.8153 54.926 48.065 54.702C48.3163 54.4766 48.6042 54.1627 48.7502 53.7502C48.7803 53.665 48.7957 53.5754 48.7957 53.4851C48.7958 52.7612 48.1676 51.9954 47.1083 51.6628C46.9644 51.6176 46.8401 51.5754 46.7333 51.5355C46.8577 51.51 46.9986 51.4839 47.1585 51.4547L47.2117 51.445C47.7264 51.3513 48.4267 51.2239 48.9957 50.9254C49.3058 50.7627 49.6161 50.531 49.8471 50.192C50.0665 49.8702 50.1852 49.4944 50.2011 49.0764C50.2116 49.0199 50.2203 48.9528 50.224 48.8761C50.2328 48.6951 50.2132 48.4676 50.1303 48.2072C49.9628 47.6813 49.5601 47.0899 48.759 46.4863C48.7149 46.4531 48.6675 46.4245 48.6176 46.401C48.3207 46.2612 48.0152 46.0997 47.734 45.9365C48.0989 45.9096 48.4969 45.9073 48.94 45.9073L48.9924 45.9073C50.5173 45.9075 52.4209 45.9078 54.1737 44.2569C54.1887 44.2428 54.2031 44.2281 54.217 44.2129C55.0437 43.3045 55.4144 42.1503 55.596 40.742C55.7744 39.3581 55.7818 37.6146 55.791 35.4519L55.7912 35.3988C55.7961 34.2399 55.8016 32.9484 55.8317 31.4996C55.8365 31.2712 55.8414 31.0422 55.8464 30.8125L55.8473 30.7738C55.9064 28.0478 55.9681 25.2052 55.6581 22.6694C55.3479 20.1323 54.6521 17.7642 53.0826 16.0932C53.0607 16.0699 53.0374 16.0479 53.0129 16.0273C50.8302 14.1999 49.0012 13.2375 46.9946 12.7423C45.0436 12.2609 42.9632 12.2345 40.3536 12.2015L40.2819 12.2006C39.5163 12.1909 38.7 12.1806 37.8179 12.1592L37.8604 12.0267C38.2095 10.9353 38.5603 9.81498 38.8244 8.9174C38.9562 8.4694 39.0684 8.07027 39.1483 7.75517C39.1881 7.5981 39.2217 7.45468 39.2459 7.33275C39.2666 7.22857 39.2925 7.08357 39.2925 6.9504C39.2925 6.45212 38.9726 6.10526 38.6974 5.92008C38.4044 5.72296 38.0401 5.61357 37.6599 5.58969C36.8805 5.54075 35.9649 5.84121 35.1216 6.63553C35.046 6.70674 34.985 6.79187 34.9421 6.8862C34.4937 7.87162 33.7154 10.1536 33.0672 12.1284H15.0628C14.8568 12.1284 14.6587 12.207 14.5093 12.348C14.2257 12.6158 14.1343 12.9569 14.1114 13.2148C14.0882 13.4761 14.1262 13.7329 14.1806 13.9481C14.2362 14.1681 14.3184 14.3815 14.4125 14.5667C14.5002 14.7391 14.6255 14.9415 14.7915 15.0978C14.9408 15.2384 15.1386 15.3168 15.3442 15.3168C15.973 15.3168 16.8794 15.3186 18.0179 15.3209L18.1135 15.3211C21.3467 15.3277 26.243 15.3376 32.041 15.3204L31.9464 15.6217L31.9135 15.7267C31.9078 15.7453 31.9026 15.764 31.8982 15.783C31.902 15.7666 31.8998 15.7736 31.8843 15.8209C31.8737 15.8532 31.8569 15.9044 31.8318 15.9798C31.78 16.1348 31.7053 16.3558 31.6095 16.6378C31.4201 17.195 31.1502 17.9851 30.8165 18.9619L30.8052 18.9949L30.8047 18.9964L30.8042 18.9979C29.1613 23.8063 25.9971 33.0675 23.333 41.2238C22.0012 45.3011 20.792 49.1096 19.96 51.95C19.5446 53.3681 19.2195 54.5574 19.0204 55.4225C18.9215 55.852 18.8487 56.2224 18.8137 56.5093C18.7965 56.6499 18.7847 56.7986 18.7907 56.9367C18.7937 57.0055 18.8019 57.0958 18.8266 57.1926C18.8486 57.2786 18.9017 57.4435 19.0428 57.5947C19.2372 57.8028 19.528 57.8927 19.8067 57.8309C20.3317 57.7146 20.79 57.3658 21.1751 56.9748C21.5743 56.5695 21.9746 56.0358 22.3734 55.4147C23.1722 54.1707 24.0246 52.4807 24.8961 50.5199C26.642 46.5921 28.5103 41.4722 30.2221 36.4062C31.9354 31.3357 33.4982 26.3006 34.6322 22.5345C35.1994 20.651 35.6596 19.0841 35.9781 17.9877C36.1374 17.4395 36.2612 17.0089 36.3453 16.7151C36.3873 16.5683 36.4194 16.4556 36.441 16.3796Z" fill="url(#paint2_linear)"/>
        <defs>
        <linearGradient id="paint0_linear" x1="35" y1="70" x2="35" y2="-20.5" gradientUnits="userSpaceOnUse">
        <stop stop-color="#976E49"/>
        <stop offset="1" stop-color="#DECBBA"/>
        </linearGradient>
        <linearGradient id="paint1_linear" x1="35" y1="70" x2="35" y2="-20.5" gradientUnits="userSpaceOnUse">
        <stop stop-color="#976E49"/>
        <stop offset="1" stop-color="#DECBBA"/>
        </linearGradient>
        <linearGradient id="paint2_linear" x1="35" y1="70" x2="35" y2="-20.5" gradientUnits="userSpaceOnUse">
        <stop stop-color="#976E49"/>
        <stop offset="1" stop-color="#DECBBA"/>
        </linearGradient>
        </defs>`;
    qrSvg += "</svg>";
    return svg64(qrSvg);
  };
  return qr;
};
